<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ä¸€é”®æˆç‰‡æ¨¡æ¿æ¨èç­–ç•¥æ¨¡æ‹Ÿå™¨</title>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js" crossorigin="anonymous" onerror="loadBackupXLSX()"></script>
  <script>
    function loadBackupXLSX() {
      console.warn('ä¸»CDNåŠ è½½å¤±è´¥ï¼Œå°è¯•å¤‡ç”¨CDN...');
      const script = document.createElement('script');
      script.src = 'https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js';
      script.onerror = () => {
        document.getElementById('fileStatus').innerText = 'XLSXåº“åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ';
        document.getElementById('fileStatus').style.color = '#ef4444';
      };
      document.head.appendChild(script);
    }
  </script>
  <style>
    :root {
      --bg: #f6f9fc;
      --card: #ffffff;
      --accent: #2f7ef9;
      --muted: #6b7280;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif;
      background: var(--bg);
      color: #111827;
    }
    header {
      padding: 16px 20px;
      background: #fff;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
      position: sticky;
      top: 0;
      z-index: 10;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    h1 {
      font-size: 18px;
      font-weight: 700;
    }
    main {
      display: grid;
      grid-template-columns: 340px 1fr;
      gap: 16px;
      padding: 16px;
      height: calc(100vh - 72px);
    }
    .card {
      background: var(--card);
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.06);
      padding: 16px;
      overflow-y: auto;
    }
    .section-title {
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-weight: 700;
      margin-bottom: 12px;
      font-size: 14px;
    }
    .field {
      margin-bottom: 12px;
    }
    .field label {
      display: block;
      font-size: 13px;
      color: var(--muted);
      margin-bottom: 6px;
    }
    .field input, .field select {
      width: 100%;
      padding: 8px 10px;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      font-size: 14px;
    }
    .btn {
      border: none;
      border-radius: 8px;
      padding: 10px 14px;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
      transition: all 0.15s ease;
    }
    .btn-primary { background: var(--accent); color: #fff; }
    .btn-secondary { background: #e5e7eb; color: #111; }
    .btn:hover { filter: brightness(0.97); }
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      filter: grayscale(0.5);
    }
    .btn:disabled:hover {
      filter: grayscale(0.5);
    }
    .sticky-note {
      background: #eef4ff;
      border: 1px solid #d7e2ff;
      padding: 10px;
      border-radius: 8px;
      font-size: 12px;
      line-height: 1.6;
      color: #1f3b7a;
      margin-top: 12px;
    }
    .result-layout {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    .top-cards {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 12px;
    }
    .card-item {
      border: 1px solid #e5e7eb;
      border-radius: 10px;
      padding: 14px;
      background: #fdfefe;
    }
    .card-item h4 {
      font-size: 14px;
      margin-bottom: 8px;
    }
    .card-item .meta {
      font-size: 12px;
      color: var(--muted);
      margin-top: 4px;
    }
    .list-container {
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      max-height: 500px;
      overflow-y: auto;
    }
    .list-item {
      display: grid;
      grid-template-columns: 50px 1fr 100px;
      gap: 12px;
      padding: 12px;
      border-bottom: 1px solid #f1f3f5;
      align-items: center;
      font-size: 13px;
    }
    .list-item:last-child { border-bottom: none; }
    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 10px;
      font-weight: 700;
      color: #fff;
      background: #8b5cf6;
      margin-left: 4px;
    }
    .muted { color: var(--muted); }
    @media (max-width: 1024px) {
      main { grid-template-columns: 1fr; height: auto; }
    }
  </style>
</head>
<body>
  <header>
    <h1>ä¸€é”®æˆç‰‡æ¨¡æ¿æ¨èç­–ç•¥æ¨¡æ‹Ÿå™¨</h1>
    <span class="muted" id="fileStatus">åŠ è½½ data3.xlsx ä¸­...</span>
  </header>
  <main>
    <!-- å·¦ä¾§å‚æ•°é¢æ¿ -->
    <aside class="card">
      <div class="section-title">
        <span>å‚æ•°è°ƒèŠ‚</span>
        <button class="btn btn-secondary" onclick="resetParams()">é‡ç½®</button>
      </div>
      
      <!-- ç”¨æˆ·ä¿¡æ¯ -->
      <div style="background:#f0f9ff;padding:12px;border-radius:8px;margin-bottom:16px;">
        <h3 style="margin:0 0 12px 0;font-size:14px;color:#0369a1;">ğŸ‘¤ ç”¨æˆ·ä¿¡æ¯</h3>
        
        <div class="field">
          <label for="userDataSelect">ä¸ªäººæ•°æ®è¡¨</label>
          <select id="userDataSelect" onchange="switchUserData()">
            <option value="">åŠ è½½ä¸­...</option>
          </select>
        </div>
        
        <div class="field">
          <label for="sceneSelect">å½“å‰ç»“æœåœºæ™¯ï¼ˆå¿…é€‰ï¼‰</label>
          <select id="sceneSelect" onchange="compute()">
            <option value="">è¯·é€‰æ‹©åœºæ™¯</option>
          </select>
        </div>
        
        <div class="field">
          <label for="userRatio">ç”¨æˆ·ç´ ææ¯”ä¾‹</label>
          <select id="userRatio" onchange="compute()">
            <option value="16:9">16:9</option>
            <option value="9:16" selected>9:16</option>
            <option value="4:3">4:3</option>
            <option value="3:4">3:4</option>
            <option value="1:1">1:1</option>
          </select>
        </div>
        
        <div class="field">
          <label>ç”¨æˆ·ç‰‡æ®µæ•°</label>
          <input id="userSegments" type="number" min="0" value="10" oninput="compute()">
        </div>
        
        <!-- ç”¨æˆ·ç»Ÿè®¡ä¿¡æ¯ -->
        <div id="userStats" style="margin-top:12px;padding-top:12px;border-top:1px solid #bae6fd;font-size:12px;color:#0c4a6e;">
          <!-- åŠ¨æ€æ˜¾ç¤ºç”¨æˆ·ç»Ÿè®¡ä¿¡æ¯ -->
        </div>
      </div>
      
      <!-- è¯„åˆ†å‚æ•° -->
      <div style="background:#fef3f2;padding:12px;border-radius:8px;margin-bottom:16px;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
          <h3 style="margin:0;font-size:14px;color:#b91c1c;">ğŸ“Š è¯„åˆ†å‚æ•°</h3>
          <div style="display:flex;align-items:center;gap:8px;">
            <label style="font-size:12px;margin:0;cursor:pointer;">
              <input type="checkbox" id="enableNewRules" onchange="toggleNewRules()" checked style="cursor:pointer;">
              å¯ç”¨E/F/Gè§„åˆ™
            </label>
          </div>
        </div>
        
        <div class="field">
          <label>åŸºç¡€åˆ†</label>
          <input id="baseScore" type="number" step="1" value="100" oninput="compute()">
        </div>
        
        <div class="field">
          <label>A ç³»æ•°ï¼ˆåœºæ™¯å¯¼å‡ºPVï¼‰</label>
          <input id="coefA" type="number" step="0.01" value="0.5" oninput="compute()">
        </div>
        
        <div class="field">
          <label>B ç³»æ•°ï¼ˆåœºæ™¯ä½¿ç”¨-å¯¼å‡ºï¼‰</label>
          <input id="coefB" type="number" step="0.01" value="0.07" oninput="compute()">
        </div>
        
        <div class="field">
          <label>C ç³»æ•°ï¼ˆä¸ªäººå¯¼å‡ºPVï¼‰</label>
          <input id="coefC" type="number" step="0.1" value="60" oninput="compute()">
        </div>
        
        <div class="field">
          <label>D ç³»æ•°ï¼ˆä¸ªäººä½¿ç”¨-å¯¼å‡ºï¼‰</label>
          <input id="coefD" type="number" step="0.1" value="30" oninput="compute()">
        </div>
        
        <hr style="margin:12px 0;border:none;border-top:1px solid #fee2e2;">
        
        <!-- E/F/G å‚æ•°åŒºï¼ˆå¯ç¦ç”¨ï¼‰ -->
        <div id="newRulesContainer">
          <div class="field">
            <label>E - æ¯”ä¾‹å®Œå…¨åŒ¹é…åˆ†</label>
            <input id="scoreRatioMatch" type="number" value="0" oninput="compute()">
          </div>
          
          <div class="field">
            <label>E - æ¯”ä¾‹è¿‘ä¼¼åŒ¹é…åˆ†ï¼ˆæ‰£åˆ†ï¼‰</label>
            <input id="scoreRatioNear" type="number" value="-200" oninput="compute()">
          </div>
          
          <div class="field">
            <label>E - æ¯”ä¾‹ä¸åŒ¹é…åˆ†ï¼ˆæ‰£åˆ†ï¼‰</label>
            <input id="scoreRatioMismatch" type="number" value="-1000" oninput="compute()">
          </div>
          
          <hr style="margin:12px 0;border:none;border-top:1px solid #fee2e2;">
          
          <div class="field">
            <label>F - ç‰‡æ®µåŒ¹é…åŠ åˆ†</label>
            <input id="scoreSegmentMatch" type="number" value="20" oninput="compute()">
          </div>
          
          <div class="field">
            <label>F - ç‰‡æ®µä¸åŒ¹é…åˆ†ï¼ˆæ‰£åˆ†ï¼‰</label>
            <input id="scoreSegmentMismatch" type="number" value="-20" oninput="compute()">
          </div>
          
          <hr style="margin:12px 0;border:none;border-top:1px solid #fee2e2;">
          
          <div class="field">
            <label>G - å¸¸è§„æ¨¡æ¿æ—¶é•¿åˆ†</label>
            <input id="scoreRegularDuration" type="number" value="20" oninput="compute()">
          </div>
          
          <div class="field">
            <label>G - é•¿æ—¶é•¿åˆ†ï¼ˆ>30sï¼‰</label>
            <input id="scoreLongDuration" type="number" value="30" oninput="compute()">
          </div>
          
          <div class="field">
            <label>G - ä¸­æ—¶é•¿åˆ†ï¼ˆ>25sï¼‰</label>
            <input id="scoreMediumDuration" type="number" value="20" oninput="compute()">
          </div>
        </div>
      </div>
      
      <div class="sticky-note">
        <strong>å…¬å¼ï¼š</strong>åˆ†æ•° = åŸºç¡€åˆ† + A - B + C - D + IDåˆ† <span style="color:#dc2626;">+ E + F + G</span><br>
        <strong>A</strong> = è¯¥æ¨¡æ¿åœ¨è¯¥åœºæ™¯çš„å¯¼å‡ºPV Ã— ç³»æ•°A<br>
        <strong>B</strong> = è¯¥æ¨¡æ¿åœ¨è¯¥åœºæ™¯çš„(ä½¿ç”¨-å¯¼å‡º)PV Ã— ç³»æ•°B<br>
        <strong>C</strong> = è¯¥æ¨¡æ¿åœ¨ä¸ªäººæ•°æ®çš„å¯¼å‡ºPV Ã— ç³»æ•°C<br>
        <strong>D</strong> = è¯¥æ¨¡æ¿åœ¨ä¸ªäººæ•°æ®çš„(ä½¿ç”¨-å¯¼å‡º)PV Ã— ç³»æ•°D<br>
        <strong>IDåˆ†</strong> = (æ¨¡æ¿ID % 10000) / 10000<br>
        <span style="color:#dc2626;"><strong>ğŸ“Œ E/F/G æ–°è§„åˆ™ï¼ˆå¯é€‰ï¼‰ï¼š</strong></span><br>
        <strong>E (æ¯”ä¾‹åˆ†)</strong> = å¡ç‚¹/å¸¸è§„:0 | UGC: å®Œå…¨åŒ¹é…0 / è¿‘ä¼¼åŒ¹é…(16:9â†”4:3,9:16â†”3:4):-200 / å…¶ä»–:-1000<br>
        <strong>F (ç‰‡æ®µåˆ†)</strong> = å¸¸è§„:0 | å¡ç‚¹/UGC: ç”¨æˆ·æ®µæ•°/æ§½ä½æ•°åœ¨0.90~1.10: +20 / å¦åˆ™:-20<br>
        <strong>G (æ—¶é•¿åˆ†)</strong> = å¸¸è§„:20 | UGC/å¡ç‚¹: >30s:30 / >25s:20 / å…¶ä»–:0<br>
        <span style="color:#dc2626;font-size:11px;">ğŸ’¡ ä¸å¯ç”¨E/F/Gæ—¶ï¼Œç›¸å½“äºä½¿ç”¨ä¼ ç»Ÿè¯„åˆ†ç³»ç»Ÿï¼ˆE=F=G=0ï¼‰</span><br><br>
        <strong style="color:#ef4444;">âš ï¸ è¿‡æ»¤è§„åˆ™ï¼ˆæŒ‰é¡ºåºåº”ç”¨ï¼‰ï¼š</strong><br>
        1. åªå±•ç¤ºåœ¨æ¨¡æ¿ä¿¡æ¯è¡¨ä¸­å­˜åœ¨çš„æ¨¡æ¿<br>
        2. ä¸æ¨èæ¨¡æ¿IDä¸º 11000000 å’Œ -1 çš„æ¨¡æ¿<br>
        3. åªæ¨èæ¨¡æ¿ä¿¡æ¯ä¸­"åœºæ™¯"åˆ—åŒ…å«å½“å‰é€‰æ‹©åœºæ™¯çš„æ¨¡æ¿<br>
        4. åœºæ™¯åˆ—åªæœ‰"é€šç”¨"çš„æ¨¡æ¿ä¸ä¼šè¢«æ¨è<br>
        â€¢ ç‰¹æ®Šè§„åˆ™ï¼šski å’Œ skiing å·²åˆå¹¶ä¸º ski<br><br>
        <strong style="color:#2f7ef9;">ğŸ“Š ä¸ªäººæ•°æ®è¡¨è¯´æ˜ï¼š</strong><br>
        â€¢ æœ‰åœºæ™¯å­—æ®µçš„è¡¨ï¼šC/D æŒ‰æ¨¡æ¿ID+åœºæ™¯åŒ¹é…<br>
        â€¢ æ— åœºæ™¯å­—æ®µçš„è¡¨ï¼šC/D æŒ‰æ¨¡æ¿IDåŒ¹é…ï¼ˆèšåˆæ•°æ®ï¼‰<br>
        â€¢ å¯åœ¨ä¸Šæ–¹åˆ‡æ¢ä½¿ç”¨ä¸åŒçš„ä¸ªäººæ•°æ®è¡¨<br><br>
        <strong style="color:#10b981;">ğŸ† TOP10 æ ‡è¯†è¯´æ˜ï¼š</strong><br>
        â€¢ <span style="background:#10b981;color:#fff;padding:2px 6px;border-radius:4px;font-size:10px;">ä¸ªäººTOP10</span> = å½“å‰ä¸ªäººæ•°æ®è¡¨ä¸­å¯¼å‡ºç‡å‰10çš„æ¨¡æ¿<br>
        â€¢ <span style="background:#3b82f6;color:#fff;padding:2px 6px;border-radius:4px;font-size:10px;">å…¨é‡TOP10</span> = å½“å‰åœºæ™¯ä¸‹å…¨ä½“æ•°æ®å¯¼å‡ºç‡å‰10çš„æ¨¡æ¿ï¼ˆéœ€ä½¿ç”¨PVâ‰¥100ï¼‰
      </div>
    </aside>

    <!-- å³ä¾§ç»“æœå±•ç¤º -->
    <section class="result-layout">
      <div class="card">
        <div class="section-title">
          <span>Top 10 æ¨¡æ¿</span>
          <span class="muted" id="topSummary"></span>
        </div>
        <div class="top-cards" id="topCards">
          <div class="muted">è¯·å…ˆé€‰æ‹©åœºæ™¯</div>
        </div>
      </div>
      
      <div class="card">
        <div class="section-title">
          <span>å…¨éƒ¨æ’åºç»“æœ</span>
          <div style="display:flex;align-items:center;gap:8px;">
            <span class="muted" id="listCount"></span>
            <button class="btn btn-primary" id="exportBtn" onclick="exportResults()" style="font-size:12px;padding:6px 12px;" disabled>
              ğŸ“¥ å¯¼å‡ºç»“æœ
            </button>
          </div>
        </div>
        <div class="list-container" id="listContainer">
          <div class="muted" style="padding:20px;">è¯·å…ˆé€‰æ‹©åœºæ™¯</div>
        </div>
      </div>
    </section>
  </main>

  <script>
    // å…¨å±€æ•°æ®
    let templateData = [];      // æ¨¡æ¿æ•°æ®ï¼ˆåœºæ™¯ç»´åº¦ç»Ÿè®¡ï¼‰
    let userData = [];           // ä¸ªäººæ•°æ®
    let templateInfo = {};       // æ¨¡æ¿ä¿¡æ¯ï¼ˆid -> {name, type}ï¼‰
    let scenes = [];             // æ‰€æœ‰åœºæ™¯åˆ—è¡¨
    let currentResults = [];     // å½“å‰è®¡ç®—ç»“æœï¼ˆç”¨äºå¯¼å‡ºï¼‰
    let currentScene = '';       // å½“å‰é€‰æ‹©çš„åœºæ™¯
    let workbook = null;         // Excelå·¥ä½œç°¿å¯¹è±¡
    let availableUserSheets = []; // å¯ç”¨çš„ä¸ªäººæ•°æ®è¡¨åˆ—è¡¨
    let currentUserSheet = '';   // å½“å‰ä½¿ç”¨çš„ä¸ªäººæ•°æ®è¡¨

    // æ¸…ç†åœºæ™¯åç§°
    function cleanScene(raw) {
      if (!raw) return '';
      const str = String(raw);
      if (str.startsWith('{')) {
        try {
          const obj = JSON.parse(str);
          return obj.video_group_scene || '';
        } catch (e) {
          return '';
        }
      }
      if (str.startsWith('PRO_VID')) return '';
      return str;
    }

    // æ ‡å‡†åŒ–åœºæ™¯åç§°ï¼ˆåˆå¹¶ skiing -> skiï¼‰
    function normalizeScene(scene) {
      if (!scene) return '';
      const s = String(scene).toLowerCase();
      if (s === 'skiing') return 'ski';
      return scene;
    }

    // è®¡ç®—IDåˆ†
    function calcIdScore(id) {
      const num = Math.abs(Number(id)) || 0;
      return ((num >= 10000000 ? num % 10000 : num) % 10000) / 10000;
    }

    // è®¡ç®—Eåˆ†ï¼ˆæ¨¡æ¿æ¯”ä¾‹åˆ†ï¼‰
    function calcRatioScore(templateType, templateRatio, userRatio, scores) {
      // å¡ç‚¹å’Œå¸¸è§„æ¨¡æ¿ï¼š0åˆ†
      if (templateType === 'å¡ç‚¹' || templateType === 'å¸¸è§„') {
        return 0;
      }
      
      // UGCæ¨¡æ¿
      if (templateType === 'ugc' || templateType === 'UGC') {
        // æ¯”ä¾‹ä¸º0ï¼ˆæœªè®¾ç½®ï¼‰ï¼šè¿”å›0åˆ†
        if (templateRatio === '0' || !templateRatio) {
          return 0;
        }
        
        // å®Œå…¨åŒ¹é…ï¼š0åˆ†
        if (templateRatio === userRatio) {
          return scores.match;
        }
        
        // è¿‘ä¼¼åŒ¹é…ï¼š16:9â†”4:3 æˆ– 9:16â†”3:4
        const nearPairs = [
          ['16:9', '4:3'],
          ['4:3', '16:9'],
          ['9:16', '3:4'],
          ['3:4', '9:16']
        ];
        
        for (const [a, b] of nearPairs) {
          if ((templateRatio === a && userRatio === b) || 
              (templateRatio === b && userRatio === a)) {
            return scores.near;
          }
        }
        
        // å…¶ä»–æƒ…å†µï¼šä¸åŒ¹é…
        return scores.mismatch;
      }
      
      return 0;
    }

    // è®¡ç®—Fåˆ†ï¼ˆæ¨¡æ¿ç‰‡æ®µåˆ†ï¼‰
    function calcSegmentScore(templateType, templateSlots, userSegments, scores) {
      // å¸¸è§„æ¨¡æ¿ï¼š0åˆ†
      if (templateType === 'å¸¸è§„') {
        return 0;
      }
      
      // å¡ç‚¹/UGCæ¨¡æ¿
      if ((templateType === 'å¡ç‚¹' || templateType === 'ugc' || templateType === 'UGC') && 
          templateSlots > 0 && userSegments > 0) {
        const ratio = userSegments / templateSlots;
        // åœ¨ 0.90 ~ 1.10 ä¹‹é—´ï¼šåŠ åˆ†
        if (ratio >= 0.90 && ratio <= 1.10) {
          return scores.match;
        } else {
          return scores.mismatch;
        }
      }
      
      return 0;
    }

    // è®¡ç®—Gåˆ†ï¼ˆæ¨¡æ¿æ—¶é•¿åˆ†ï¼‰
    function calcDurationScore(templateType, duration, scores) {
      // å¸¸è§„æ¨¡æ¿ï¼šå›ºå®šåˆ†æ•°
      if (templateType === 'å¸¸è§„') {
        return scores.regular;
      }
      
      // UGC/å¡ç‚¹æ¨¡æ¿
      if (templateType === 'å¡ç‚¹' || templateType === 'ugc' || templateType === 'UGC') {
        if (duration > 30) {
          return scores.long;
        } else if (duration > 25) {
          return scores.medium;
        } else {
          return 0;
        }
      }
      
      return 0;
    }

    // åŠ è½½ä¸ªäººæ•°æ®è¡¨
    function loadUserData(userSheetName) {
      if (!workbook || !userSheetName) {
        console.error('å·¥ä½œç°¿æœªåŠ è½½æˆ–æœªæŒ‡å®šä¸ªäººæ•°æ®è¡¨');
        return;
      }
      
      const userSheet = workbook.Sheets[userSheetName];
      if (!userSheet) {
        console.error(`æœªæ‰¾åˆ°ä¸ªäººæ•°æ®è¡¨: ${userSheetName}`);
        return;
      }
      
      // å…ˆå°è¯•é»˜è®¤è¯»å–ï¼Œæ£€æŸ¥ç¬¬ä¸€è¡Œæ˜¯å¦æ˜¯è¡¨å¤´
      let raw = XLSX.utils.sheet_to_json(userSheet);
      console.log(`è¯»å–ä¸ªäººæ•°æ®è¡¨: ${userSheetName}, ${raw.length} æ¡åŸå§‹è®°å½•`);
      
      if (raw.length > 0) {
        console.log('ç¬¬ä¸€æ¡æ•°æ®ç¤ºä¾‹:', raw[0]);
        const firstKeys = Object.keys(raw[0]);
        console.log('æ£€æµ‹åˆ°çš„åˆ—å:', firstKeys);
        
        // æ£€æŸ¥æ˜¯å¦ç¬¬ä¸€è¡Œæ˜¯"è¡¨æ ¼ 1"ä¹‹ç±»çš„ï¼ˆéœ€è¦è·³è¿‡ï¼‰
        if (firstKeys.some(k => k.includes('è¡¨æ ¼') || k.includes('Unnamed'))) {
          console.log('æ£€æµ‹åˆ°éœ€è¦è·³è¿‡ç¬¬ä¸€è¡Œï¼Œé‡æ–°è¯»å–...');
          raw = XLSX.utils.sheet_to_json(userSheet, { range: 1 });
          console.log(`é‡æ–°è¯»å–å: ${raw.length} æ¡è®°å½•`);
          if (raw.length > 0) {
            console.log('é‡æ–°è¯»å–åçš„ç¬¬ä¸€æ¡:', raw[0]);
            console.log('é‡æ–°è¯»å–åçš„åˆ—å:', Object.keys(raw[0]));
          }
        }
      }
      
      // æ£€æŸ¥æ˜¯å¦æœ‰åœºæ™¯å­—æ®µ
      const hasSceneField = raw.length > 0 && ('åœºæ™¯' in raw[0]);
      console.log(`ä¸ªäººæ•°æ®æ˜¯å¦åŒ…å«åœºæ™¯å­—æ®µ: ${hasSceneField}`);
      
      userData = raw.map(r => {
        // å°è¯•ä¸åŒçš„åˆ—åå˜ä½“
        const templateId = r['æ¨¡æ¿id'] || r['æ¨¡æ¿ID'] || r['template_id'] || '';
        const usePv = Number(r['ä½¿ç”¨pv'] || r['ä½¿ç”¨PV'] || r['use_pv'] || 0);
        const exportPv = Number(r['å¯¼å‡ºpv'] || r['å¯¼å‡ºPV'] || r['export_pv'] || 0);
        // è¯»å–å¯¼å‡ºç‡ï¼Œå¦‚æœä¸ºç©ºæˆ–NaNï¼Œåˆ™è‡ªåŠ¨è®¡ç®—
        let exportRate = Number(r['å¯¼å‡ºç‡'] || r['export_rate']);
        if (isNaN(exportRate) || exportRate === 0) {
          exportRate = usePv > 0 ? exportPv / usePv : 0;
        }
        
        if (hasSceneField) {
          // æœ‰åœºæ™¯å­—æ®µï¼šæŒ‰æ¨¡æ¿ID+åœºæ™¯åŒ¹é…
          const sceneVal = r['åœºæ™¯'] || r['scene'] || '';
          const cleanedScene = cleanScene(sceneVal);
          return {
            id: String(templateId),
            scene: normalizeScene(cleanedScene),
            usePv: usePv,
            exportPv: exportPv,
            exportRate: exportRate,
            hasScene: true
          };
        } else {
          // æ— åœºæ™¯å­—æ®µï¼šåªæŒ‰æ¨¡æ¿IDåŒ¹é…ï¼ˆèšåˆæ•°æ®ï¼‰
          return {
            id: String(templateId),
            scene: null,
            usePv: usePv,
            exportPv: exportPv,
            exportRate: exportRate,
            hasScene: false
          };
        }
      }).filter(r => r.id && r.id !== 'æ¨¡æ¿id' && r.id !== 'template_id');
      
      console.log(`ä¸ªäººæ•°æ®å¤„ç†å: ${userData.length} æ¡æœ‰æ•ˆè®°å½•`);
      if (userData.length > 0) {
        console.log('ä¸ªäººæ•°æ®ç¬¬ä¸€æ¡ç¤ºä¾‹:', userData[0]);
      }
      
      currentUserSheet = userSheetName;
      
      // æ›´æ–°çŠ¶æ€æ æ˜¾ç¤º
      const statusEl = document.getElementById('fileStatus');
      const statusText = statusEl.innerText;
      if (statusText.includes('å·²åŠ è½½')) {
        const parts = statusText.split('ï¼Œ');
        parts[1] = `${userData.length} æ¡ä¸ªäººæ•°æ®ï¼ˆ${userSheetName}${hasSceneField ? 'ï¼ŒåŒºåˆ†åœºæ™¯' : 'ï¼Œèšåˆæ•°æ®'}ï¼‰`;
        statusEl.innerText = parts.join('ï¼Œ');
      }
      
      // æ¸²æŸ“ç”¨æˆ·ç»Ÿè®¡ä¿¡æ¯
      renderUserStats();
    }
    
    // æ¸²æŸ“ç”¨æˆ·ç»Ÿè®¡ä¿¡æ¯
    function renderUserStats() {
      const statsContainer = document.getElementById('userStats');
      
      if (!userData || userData.length === 0) {
        statsContainer.innerHTML = '<div style="color:#64748b;">æš‚æ— ä¸ªäººæ•°æ®</div>';
        return;
      }
      
      const hasSceneData = userData.length > 0 && userData[0].hasScene;
      
      // åˆ¤æ–­æ˜¯å¦éœ€è¦æŒ‰åœºæ™¯åŒºåˆ†æ˜¾ç¤ºï¼šåªæœ‰"ä¸ªäººæ•°æ®"ï¼ˆç¬¬ä¸€ä¸ªè¡¨ï¼Œæ— æ•°å­—ï¼‰æ‰æŒ‰åœºæ™¯åŒºåˆ†
      const shouldSeparateByScene = hasSceneData && currentUserSheet === 'ä¸ªäººæ•°æ®';
      
      // 1. è®¡ç®—æ•´ä½“å¯¼å‡ºç‡ï¼ˆæ‰€æœ‰æ•°æ®ï¼‰
      const totalUsePv = userData.reduce((sum, u) => sum + u.usePv, 0);
      const totalExportPv = userData.reduce((sum, u) => sum + u.exportPv, 0);
      const overallExportRate = totalUsePv > 0 ? (totalExportPv / totalUsePv * 100) : 0;
      
      // 2. ç»Ÿè®¡åœºæ™¯ä½¿ç”¨æƒ…å†µï¼ˆå¦‚æœæœ‰åœºæ™¯å­—æ®µï¼‰
      let topScenes = [];
      
      if (hasSceneData) {
        // æŒ‰åœºæ™¯ç»Ÿè®¡ä½¿ç”¨PV
        const sceneStats = {};
        userData.forEach(u => {
          if (u.scene) {
            if (!sceneStats[u.scene]) {
              sceneStats[u.scene] = 0;
            }
            sceneStats[u.scene] += u.usePv;
          }
        });
        
        // æ’åºå¹¶å–å‰2
        topScenes = Object.entries(sceneStats)
          .sort((a, b) => b[1] - a[1])
          .slice(0, 2)
          .map(([scene, pv]) => `${scene}(${pv}PV)`);
      }
      
      // 3. è®¡ç®—Top10æ¨¡æ¿
      let top10Data;
      
      if (shouldSeparateByScene) {
        // "ä¸ªäººæ•°æ®"è¡¨ï¼šæŒ‰åœºæ™¯åŒºåˆ†ï¼Œä¸èšåˆ
        top10Data = userData.map(u => ({
          id: u.id,
          scene: u.scene,
          usePv: u.usePv,
          exportPv: u.exportPv,
          exportRate: u.exportRate || 0,
          scenes: [u.scene],
          isSeparated: true
        }));
      } else if (hasSceneData) {
        // "ä¸ªäººæ•°æ®2-6"æœ‰åœºæ™¯æ•°æ®ï¼šæŒ‰æ¨¡æ¿IDèšåˆ
        const templateAggregated = {};
        userData.forEach(u => {
          if (!templateAggregated[u.id]) {
            templateAggregated[u.id] = {
              id: u.id,
              usePv: 0,
              exportPv: 0,
              scenes: []
            };
          }
          templateAggregated[u.id].usePv += u.usePv;
          templateAggregated[u.id].exportPv += u.exportPv;
          if (u.scene && !templateAggregated[u.id].scenes.includes(u.scene)) {
            templateAggregated[u.id].scenes.push(u.scene);
          }
        });
        
        // è®¡ç®—èšåˆåçš„å¯¼å‡ºç‡
        top10Data = Object.values(templateAggregated).map(t => ({
          ...t,
          exportRate: t.usePv > 0 ? t.exportPv / t.usePv : 0,
          isSeparated: false
        }));
      } else {
        // æ²¡æœ‰åœºæ™¯æ•°æ®ï¼šç›´æ¥ä½¿ç”¨
        top10Data = userData.map(u => ({
          id: u.id,
          usePv: u.usePv,
          exportPv: u.exportPv,
          exportRate: u.exportRate || 0,
          scenes: [],
          isSeparated: false
        }));
      }
      
      // æŒ‰å¯¼å‡ºç‡æ’åºå¹¶å–å‰10
      const sortedByRate = top10Data.sort((a, b) => (b.exportRate || 0) - (a.exportRate || 0));
      const top10 = sortedByRate.slice(0, 10);
      
      // ç”ŸæˆHTML
      const templateCount = hasSceneData ? top10Data.length : userData.length;
      
      let html = `
        <div style="margin-bottom:8px;">
          <strong>ğŸ“Š æ•´ä½“å¯¼å‡ºç‡ï¼š</strong><span style="color:#0369a1;font-weight:bold;">${overallExportRate.toFixed(2)}%</span>
          <span style="color:#64748b;font-size:11px;margin-left:4px;">(${templateCount}ä¸ªæ¨¡æ¿)</span>
        </div>
      `;
      
      if (hasSceneData && topScenes.length > 0) {
        html += `
          <div style="margin-bottom:8px;">
            <strong>ğŸ¯ ä½¿ç”¨æœ€å¤šçš„åœºæ™¯ï¼š</strong>${topScenes.join('ã€')}
          </div>
        `;
      } else if (!hasSceneData) {
        html += `
          <div style="margin-bottom:8px;">
            <strong>ğŸ“¦ æ•°æ®ç±»å‹ï¼š</strong>èšåˆæ•°æ®ï¼ˆæ— åœºæ™¯åŒºåˆ†ï¼‰
          </div>
        `;
      }
      
      html += `
        <div style="margin-top:8px;">
          <strong>ğŸ† ä¸ªäººTOP10æ¨¡æ¿ï¼š</strong>
          <div style="max-height:200px;overflow-y:auto;margin-top:4px;background:#fff;padding:8px;border-radius:4px;border:1px solid #e0f2fe;">
      `;
      
      top10.forEach((t, i) => {
        const info = templateInfo[t.id] || {};
        const name = info.name || `æ¨¡æ¿${t.id}`;
        const rate = ((t.exportRate || 0) * 100).toFixed(2);
        
        // æ˜¾ç¤ºåœºæ™¯ä¿¡æ¯
        let sceneText = '';
        if (t.isSeparated && t.scene) {
          // "ä¸ªäººæ•°æ®"è¡¨ï¼šæ˜¾ç¤ºå•ä¸ªåœºæ™¯
          sceneText = `<span style="color:#64748b;font-size:10px;">[${t.scene}]</span>`;
        } else if (hasSceneData && t.scenes && t.scenes.length > 0) {
          // å…¶ä»–æœ‰åœºæ™¯çš„è¡¨ï¼šæ˜¾ç¤ºåœºæ™¯åˆ—è¡¨
          sceneText = `<span style="color:#64748b;font-size:10px;">[${t.scenes.join(',')}]</span>`;
        }
        
        html += `
          <div style="font-size:11px;padding:3px 0;border-bottom:1px solid #f0f9ff;display:flex;justify-content:space-between;">
            <span style="color:#0c4a6e;">
              ${i + 1}. ${name} ${sceneText}
            </span>
            <span style="color:#0369a1;font-weight:bold;">${rate}%</span>
          </div>
        `;
      });
      
      html += `
          </div>
        </div>
      `;
      
      statsContainer.innerHTML = html;
    }

    // åŠ è½½æ•°æ®
    async function loadData() {
      try {
        console.log('å¼€å§‹åŠ è½½ data3.xlsx...');
        const res = await fetch('data3.xlsx');
        console.log('Fetchå“åº”:', res.status, res.statusText);
        if (!res.ok) throw new Error(`HTTP ${res.status}: ${res.statusText}`);
        
        const buf = await res.arrayBuffer();
        console.log('æ–‡ä»¶å¤§å°:', buf.byteLength, 'bytes');
        workbook = XLSX.read(buf, { type: 'array' });
        const wb = workbook; // å‘åå…¼å®¹
        console.log('å·¥ä½œè¡¨:', wb.SheetNames);
        
        // æ£€æµ‹æ‰€æœ‰ä¸ªäººæ•°æ®è¡¨ï¼ˆä»¥"ä¸ªäººæ•°æ®"å¼€å¤´çš„å·¥ä½œè¡¨ï¼‰
        availableUserSheets = wb.SheetNames.filter(name => name.startsWith('ä¸ªäººæ•°æ®'));
        console.log('å¯ç”¨çš„ä¸ªäººæ•°æ®è¡¨:', availableUserSheets);
        
        // è¯»å–æ¨¡æ¿æ•°æ®è¡¨
        const tplSheet = wb.Sheets['æ¨¡æ¿æ•°æ®'];
        if (tplSheet) {
          const raw = XLSX.utils.sheet_to_json(tplSheet);
          const tempData = raw.map(r => {
            const cleanedScene = cleanScene(r['åœºæ™¯'] || '');
            const usePv = Number(r['finish_analyze_pv'] || r['ä½¿ç”¨pv'] || 0);
            const exportPv = Number(r['export_pv'] || r['å¯¼å‡ºpv'] || 0);
            // è¯»å–å¯¼å‡ºç‡ï¼Œå¦‚æœä¸ºç©ºæˆ–NaNï¼Œåˆ™è‡ªåŠ¨è®¡ç®—
            let exportRate = Number(r['å¯¼å‡ºç‡']);
            if (isNaN(exportRate) || exportRate === 0) {
              exportRate = usePv > 0 ? exportPv / usePv : 0;
            }
            return {
              id: String(r['æ¨¡æ¿id'] || ''),
              scene: normalizeScene(cleanedScene), // æ ‡å‡†åŒ–åœºæ™¯åç§°
              originalScene: cleanedScene, // ä¿ç•™åŸå§‹åœºæ™¯ç”¨äºè°ƒè¯•
              usePv: usePv,
              exportPv: exportPv,
              exportRate: exportRate // æ·»åŠ å¯¼å‡ºç‡å­—æ®µï¼ˆè‡ªåŠ¨è®¡ç®—ï¼‰
            };
          }).filter(r => r.id && r.scene);
          
          // åˆå¹¶åŒä¸€æ¨¡æ¿åœ¨åŒä¸€åœºæ™¯çš„é‡å¤è®°å½•
          const mergedMap = {};
          tempData.forEach(r => {
            const key = `${r.id}_${r.scene}`;
            if (mergedMap[key]) {
              // å¦‚æœå·²å­˜åœ¨ï¼Œç´¯åŠ PVå€¼
              mergedMap[key].usePv += r.usePv;
              mergedMap[key].exportPv += r.exportPv;
              // é‡æ–°è®¡ç®—å¯¼å‡ºç‡
              mergedMap[key].exportRate = mergedMap[key].usePv > 0 ? mergedMap[key].exportPv / mergedMap[key].usePv : 0;
              console.log(`åˆå¹¶é‡å¤è®°å½•ï¼šæ¨¡æ¿${r.id}åœ¨åœºæ™¯${r.scene}ï¼Œç´¯åŠ åä½¿ç”¨PV=${mergedMap[key].usePv}ï¼Œå¯¼å‡ºPV=${mergedMap[key].exportPv}`);
            } else {
              mergedMap[key] = r;
            }
          });
          
          templateData = Object.values(mergedMap);
          console.log(`æ¨¡æ¿æ•°æ®ï¼šåŸå§‹${tempData.length}æ¡ â†’ å»é‡å${templateData.length}æ¡`);
        }
        
        // åˆå§‹åŒ–ä¸ªäººæ•°æ®è¡¨é€‰æ‹©å™¨
        const userDataSelect = document.getElementById('userDataSelect');
        if (availableUserSheets.length > 0) {
          // æ™ºèƒ½é€‰æ‹©ï¼šä¼˜å…ˆé€‰æ‹©åºå·æœ€å¤§çš„ä¸ªäººæ•°æ®è¡¨ï¼ˆå¦‚ä¸ªäººæ•°æ®3 > ä¸ªäººæ•°æ®2 > ä¸ªäººæ•°æ®ï¼‰
          const sortedSheets = [...availableUserSheets].sort((a, b) => {
            const numA = parseInt(a.replace('ä¸ªäººæ•°æ®', '') || '0');
            const numB = parseInt(b.replace('ä¸ªäººæ•°æ®', '') || '0');
            return numB - numA;  // é™åºæ’åˆ—
          });
          const defaultSheet = sortedSheets[0];
          
          // æŒ‰åºå·æ’åºæ˜¾ç¤ºï¼ˆé™åºï¼š3, 2, 1ï¼‰
          userDataSelect.innerHTML = sortedSheets.map(name => 
            `<option value="${name}" ${name === defaultSheet ? 'selected' : ''}>${name}</option>`
          ).join('');
          
          // åŠ è½½é»˜è®¤çš„ä¸ªäººæ•°æ®è¡¨
          loadUserData(defaultSheet);
        } else {
          userDataSelect.innerHTML = '<option value="">æœªæ‰¾åˆ°ä¸ªäººæ•°æ®è¡¨</option>';
        }
        
        // è¯»å–æ¨¡æ¿ä¿¡æ¯è¡¨ï¼ˆä¼˜å…ˆè¯»å–æ¨¡æ¿ä¿¡æ¯2ï¼Œä½†ä¹Ÿåˆå¹¶æ¨¡æ¿ä¿¡æ¯è¡¨ä»¥ç¡®ä¿å®Œæ•´æ€§ï¼‰
        const infoSheets = ['æ¨¡æ¿ä¿¡æ¯2', 'æ¨¡æ¿ä¿¡æ¯'].filter(name => wb.SheetNames.includes(name));
        
        if (infoSheets.length === 0) {
          throw new Error('æœªæ‰¾åˆ°æ¨¡æ¿ä¿¡æ¯è¡¨');
        }
        
        console.log('è¯»å–æ¨¡æ¿ä¿¡æ¯è¡¨:', infoSheets);
        
        // åˆå¹¶å¤šä¸ªæ¨¡æ¿ä¿¡æ¯è¡¨
        infoSheets.forEach(infoSheetName => {
          const infoSheet = wb.Sheets[infoSheetName];
          if (infoSheet) {
            const raw = XLSX.utils.sheet_to_json(infoSheet, { range: 1 }); // ä»ç¬¬2è¡Œå¼€å§‹è¯»å–
            console.log(`  ${infoSheetName}: ${raw.length} æ¡åŸå§‹è®°å½•`);
            if (raw.length > 0 && infoSheetName === infoSheets[0]) {
              console.log('  ç¬¬ä¸€æ¡æ•°æ®ç¤ºä¾‹:', raw[0]);
            }
            
            // åˆå¹¶é‡å¤çš„æ¨¡æ¿ID
            raw.forEach(r => {
              const id = String(r['æ¨¡æ¿id'] || '');
              const name = r['æ¨¡æ¿åç§°'] || '';
              const type = r['æ¨¡æ¿ç±»å‹'] || '';
              const sceneStr = String(r['åœºæ™¯'] || '');
              
              // æ–°å¢å­—æ®µï¼ˆæ¥è‡ªæ¨¡æ¿ä¿¡æ¯2ï¼‰
              const duration = Number(r['æ¨¡æ¿æ—¶é•¿'] || 0);
              const slots = Number(r['æ¨¡æ¿æ§½ä½æ•°'] || 0);
              const ratio = String(r['æ¨¡æ¿æ¯”ä¾‹(å‡)'] || r['æ¨¡æ¿æ¯”ä¾‹'] || '0');
              
              // è¿‡æ»¤è¡¨å¤´è¡Œ
              if (id && id !== 'æ¨¡æ¿id' && name && name !== 'æ¨¡æ¿åç§°') {
                // è§£æåœºæ™¯åˆ—è¡¨ï¼ˆé€—å·åˆ†éš”ï¼‰
                const sceneList = sceneStr.split(/[,ï¼Œ]/).map(s => s.trim()).filter(s => s);
                
                // å¦‚æœæ¨¡æ¿IDå·²å­˜åœ¨ï¼Œåˆå¹¶åœºæ™¯
                if (templateInfo[id]) {
                  // åˆå¹¶åœºæ™¯åˆ—è¡¨å¹¶å»é‡
                  const existingScenes = templateInfo[id].scenes || [];
                  const mergedScenes = [...new Set([...existingScenes, ...sceneList])];
                  templateInfo[id].scenes = mergedScenes;
                  // å¦‚æœåç§°æ›´è¯¦ç»†ï¼Œæ›´æ–°åç§°
                  if (name.length > templateInfo[id].name.length) {
                    templateInfo[id].name = name;
                  }
                  // æ›´æ–°å…¶ä»–å­—æ®µï¼ˆä¿ç•™éé›¶å€¼ï¼‰
                  if (duration > 0) templateInfo[id].duration = duration;
                  if (slots > 0) templateInfo[id].slots = slots;
                  if (ratio && ratio !== '0') templateInfo[id].ratio = ratio;
                  // å¦‚æœæ—§æ•°æ®ç¼ºå°‘typeä½†æ–°æ•°æ®æœ‰ï¼Œæ›´æ–°type
                  if (!templateInfo[id].type && type) templateInfo[id].type = type;
                } else {
                  templateInfo[id] = { 
                    name, 
                    type, 
                    scenes: sceneList,
                    duration: duration,
                    slots: slots,
                    ratio: ratio
                  };
                }
              }
            });
          }
        });
        
        console.log('åˆå¹¶åçš„å”¯ä¸€æ¨¡æ¿æ•°é‡:', Object.keys(templateInfo).length);
        // æ‰“å°å‰å‡ ä¸ªæ¨¡æ¿çš„å®Œæ•´ä¿¡æ¯
        Object.entries(templateInfo).slice(0, 3).forEach(([id, info]) => {
          console.log(`æ¨¡æ¿ ${id}: ${info.name}, ç±»å‹:${info.type}, åœºæ™¯:${info.scenes}, æ—¶é•¿:${info.duration}s, æ§½ä½:${info.slots}, æ¯”ä¾‹:${info.ratio}`);
        });
        
        // æå–åœºæ™¯åˆ—è¡¨ï¼ˆå·²ç»æ ‡å‡†åŒ–è¿‡ï¼Œskiing å·²è½¬ä¸º skiï¼‰
        scenes = [...new Set(templateData.map(t => t.scene))].sort();
        console.log('å¯é€‰åœºæ™¯åˆ—è¡¨:', scenes);
        
        // æ›´æ–°åœºæ™¯ä¸‹æ‹‰æ¡†
        const select = document.getElementById('sceneSelect');
        select.innerHTML = '<option value="">è¯·é€‰æ‹©åœºæ™¯</option>' + 
          scenes.map(s => `<option value="${s}">${s}</option>`).join('');
        
        // é»˜è®¤é€‰æ‹©ç¬¬ä¸€ä¸ªåœºæ™¯
        if (scenes.length > 0) {
          select.value = scenes[0];
        }
        
        const infoCount = Object.keys(templateInfo).length;
        const rawInfoCount = wb.Sheets['æ¨¡æ¿ä¿¡æ¯'] ? 
          XLSX.utils.sheet_to_json(wb.Sheets['æ¨¡æ¿ä¿¡æ¯'], { range: 1 }).length : 0;
        const statusText = rawInfoCount > infoCount 
          ? `âœ“ å·²åŠ è½½ ${templateData.length} æ¡æ¨¡æ¿æ•°æ®ï¼Œ${userData.length} æ¡ä¸ªäººæ•°æ®ï¼Œ${infoCount} ä¸ªå”¯ä¸€æ¨¡æ¿ï¼ˆåŸå§‹${rawInfoCount}æ¡ï¼Œå·²åˆå¹¶é‡å¤ï¼‰`
          : `âœ“ å·²åŠ è½½ ${templateData.length} æ¡æ¨¡æ¿æ•°æ®ï¼Œ${userData.length} æ¡ä¸ªäººæ•°æ®ï¼Œ${infoCount} æ¡æ¨¡æ¿ä¿¡æ¯`;
        document.getElementById('fileStatus').innerText = statusText;
        
        console.log('æ•°æ®åŠ è½½å®Œæˆ');
        compute();
      } catch (e) {
        const errMsg = 'åŠ è½½å¤±è´¥: ' + e.message;
        document.getElementById('fileStatus').innerText = errMsg;
        document.getElementById('fileStatus').style.color = '#ef4444';
        document.getElementById('topCards').innerHTML = `<div style="color:#ef4444;padding:20px;">${errMsg}<br><br>è¯·ç¡®ä¿ï¼š<br>1. ä½¿ç”¨ http://localhost:8000 è®¿é—®ï¼ˆä¸æ˜¯ file://ï¼‰<br>2. æ–‡ä»¶ data3.xlsx åœ¨åŒç›®å½•<br>3. æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°è·å–è¯¦ç»†é”™è¯¯</div>`;
        console.error('åŠ è½½é”™è¯¯è¯¦æƒ…:', e);
        console.error('é”™è¯¯å †æ ˆ:', e.stack);
      }
    }

    // åˆ‡æ¢æ–°è§„åˆ™å¼€å…³
    function toggleNewRules() {
      const enabled = document.getElementById('enableNewRules').checked;
      const container = document.getElementById('newRulesContainer');
      
      if (enabled) {
        container.style.opacity = '1';
        container.style.pointerEvents = 'auto';
      } else {
        container.style.opacity = '0.4';
        container.style.pointerEvents = 'none';
      }
      
      // é‡æ–°è®¡ç®—
      compute();
    }

    // è®¡ç®—æ¨èç»“æœ
    function compute() {
      const scene = document.getElementById('sceneSelect').value;
      
      if (!scene) {
        document.getElementById('topCards').innerHTML = '<div class="muted">è¯·å…ˆé€‰æ‹©åœºæ™¯</div>';
        document.getElementById('listContainer').innerHTML = '<div class="muted" style="padding:20px;">è¯·å…ˆé€‰æ‹©åœºæ™¯</div>';
        document.getElementById('topSummary').innerText = '';
        document.getElementById('listCount').innerText = '';
        document.getElementById('exportBtn').disabled = true;
        currentResults = [];
        currentScene = '';
        return;
      }
      
      // å¯ç”¨å¯¼å‡ºæŒ‰é’®
      document.getElementById('exportBtn').disabled = false;
      
      // è·å–å‚æ•°
      const baseScore = Number(document.getElementById('baseScore').value) || 0;
      const coefA = Number(document.getElementById('coefA').value) || 0;
      const coefB = Number(document.getElementById('coefB').value) || 0;
      const coefC = Number(document.getElementById('coefC').value) || 0;
      const coefD = Number(document.getElementById('coefD').value) || 0;
      
      // ç­›é€‰è¯¥åœºæ™¯çš„æ•°æ®
      let sceneData = templateData.filter(t => t.scene === scene);
      const beforeFilterCount = sceneData.length;
      
      // 1. è¿‡æ»¤ï¼šåªä¿ç•™åœ¨æ¨¡æ¿ä¿¡æ¯è¡¨ä¸­å­˜åœ¨çš„æ¨¡æ¿
      sceneData = sceneData.filter(t => {
        if (!templateInfo[t.id]) {
          console.log(`è¿‡æ»¤ï¼šæ¨¡æ¿${t.id}ä¸åœ¨æ¨¡æ¿ä¿¡æ¯è¡¨ä¸­`);
          return false;
        }
        return true;
      });
      
      const afterInfoFilterCount = sceneData.length;
      
      // 2. IDé»‘åå•è¿‡æ»¤ï¼šè¿‡æ»¤æ‰ä¸æ¨èçš„æ¨¡æ¿ID
      const blacklistIds = ['11000000', '-1'];
      sceneData = sceneData.filter(t => {
        if (blacklistIds.includes(String(t.id))) {
          console.log(`è¿‡æ»¤ï¼šæ¨¡æ¿${t.id}åœ¨é»‘åå•ä¸­`);
          return false;
        }
        return true;
      });
      
      const afterBlacklistCount = sceneData.length;
      
      // 3. åœºæ™¯è¿‡æ»¤ï¼šåªä¿ç•™æ¨¡æ¿ä¿¡æ¯ä¸­åœºæ™¯åˆ—åŒ…å«å½“å‰åœºæ™¯çš„æ¨¡æ¿
      // è¿‡æ»¤æ‰åœºæ™¯åªæœ‰"é€šç”¨"çš„æ¨¡æ¿
      sceneData = sceneData.filter(t => {
        const info = templateInfo[t.id];
        // ç”±äºå‰é¢å·²ç»è¿‡æ»¤æ‰ä¸åœ¨æ¨¡æ¿ä¿¡æ¯è¡¨ä¸­çš„æ¨¡æ¿ï¼Œè¿™é‡Œ info åº”è¯¥æ€»æ˜¯å­˜åœ¨
        if (!info || !info.scenes || info.scenes.length === 0) {
          console.log(`è¿‡æ»¤ï¼šæ¨¡æ¿${t.id}(${info?.name || 'æœªçŸ¥'})æ²¡æœ‰åœºæ™¯ä¿¡æ¯`);
          return false;
        }
        
        // å¦‚æœåœºæ™¯åˆ—è¡¨åªæœ‰"é€šç”¨"ï¼Œåˆ™ä¸æ¨è
        if (info.scenes.length === 1 && info.scenes[0] === 'é€šç”¨') {
          console.log(`è¿‡æ»¤ï¼šæ¨¡æ¿${t.id}(${info.name})åªæœ‰"é€šç”¨"åœºæ™¯`);
          return false;
        }
        
        // æ£€æŸ¥åœºæ™¯åˆ—è¡¨æ˜¯å¦åŒ…å«å½“å‰é€‰æ‹©çš„åœºæ™¯
        // ç‰¹æ®Šå¤„ç†ï¼šå¦‚æœé€‰æ‹© skiï¼Œä¹ŸåŒ¹é… skiing
        const sceneToMatch = scene.toLowerCase();
        const matched = info.scenes.some(s => {
          const infoScene = s.toLowerCase();
          if (sceneToMatch === 'ski') {
            return infoScene === 'ski' || infoScene === 'skiing';
          }
          return infoScene === sceneToMatch;
        });
        
        if (!matched) {
          console.log(`è¿‡æ»¤ï¼šæ¨¡æ¿${t.id}(${info.name})çš„åœºæ™¯[${info.scenes.join(',')}]ä¸åŒ…å«${scene}`);
        }
        return matched;
      });
      
      console.log(`åœºæ™¯"${scene}"ï¼šåˆå§‹${beforeFilterCount}ä¸ª â†’ æ¨¡æ¿ä¿¡æ¯è¡¨è¿‡æ»¤å${afterInfoFilterCount}ä¸ª â†’ é»‘åå•è¿‡æ»¤å${afterBlacklistCount}ä¸ª â†’ åœºæ™¯åŒ¹é…è¿‡æ»¤å${sceneData.length}ä¸ª`);
      
      if (sceneData.length === 0) {
        document.getElementById('topCards').innerHTML = `<div class="muted">åœºæ™¯"${scene}"æš‚æ— ç¬¦åˆæ¡ä»¶çš„æ¨¡æ¿</div>`;
        document.getElementById('listContainer').innerHTML = '<div class="muted" style="padding:20px;">æš‚æ— ç¬¦åˆæ¡ä»¶çš„æ¨¡æ¿</div>';
        document.getElementById('exportBtn').disabled = true;
        currentResults = [];
        currentScene = '';
        return;
      }
      
      // å»ºç«‹ä¸ªäººæ•°æ®æ˜ å°„
      const userMap = {};
      const userHasScene = userData.length > 0 && userData[0].hasScene;
      
      userData.forEach(u => {
        if (userHasScene) {
          // æœ‰åœºæ™¯å­—æ®µï¼šæŒ‰æ¨¡æ¿ID_åœºæ™¯åŒ¹é…
          const key = `${u.id}_${u.scene}`;
          userMap[key] = u;
        } else {
          // æ— åœºæ™¯å­—æ®µï¼šåªæŒ‰æ¨¡æ¿IDåŒ¹é…ï¼ˆèšåˆæ•°æ®ï¼‰
          userMap[u.id] = u;
        }
      });
      
      console.log(`ä¸ªäººæ•°æ®åŒ¹é…æ¨¡å¼: ${userHasScene ? 'æ¨¡æ¿ID+åœºæ™¯' : 'ä»…æ¨¡æ¿IDï¼ˆèšåˆï¼‰'}`);
      
      // è·å–ç”¨æˆ·å‚æ•°
      const userRatio = document.getElementById('userRatio').value;
      const userSegments = Number(document.getElementById('userSegments').value) || 0;
      
      // è·å–E/F/Gè¯„åˆ†å‚æ•°
      const ratioScores = {
        match: Number(document.getElementById('scoreRatioMatch').value) || 0,
        near: Number(document.getElementById('scoreRatioNear').value) || -200,
        mismatch: Number(document.getElementById('scoreRatioMismatch').value) || -1000
      };
      
      const segmentScores = {
        match: Number(document.getElementById('scoreSegmentMatch').value) || 20,
        mismatch: Number(document.getElementById('scoreSegmentMismatch').value) || -20
      };
      
      const durationScores = {
        regular: Number(document.getElementById('scoreRegularDuration').value) || 20,
        long: Number(document.getElementById('scoreLongDuration').value) || 30,
        medium: Number(document.getElementById('scoreMediumDuration').value) || 20
      };
      
      // è®¡ç®—ä¸ªäººæ•°æ®å¯¼å‡ºç‡å‰å
      const personalTop10ByRate = new Set();
      if (userData.length > 0) {
        // åˆ¤æ–­æ˜¯å¦éœ€è¦æŒ‰åœºæ™¯åŒºåˆ†ï¼šåªæœ‰"ä¸ªäººæ•°æ®"ï¼ˆç¬¬ä¸€ä¸ªè¡¨ï¼‰æ‰æŒ‰åœºæ™¯åŒºåˆ†
        const shouldSeparateByScene = userHasScene && currentUserSheet === 'ä¸ªäººæ•°æ®';
        let personalDataAggregated;
        
        if (shouldSeparateByScene) {
          // "ä¸ªäººæ•°æ®"è¡¨ï¼šä¸èšåˆï¼Œç›´æ¥ä½¿ç”¨åŸå§‹æ•°æ®
          personalDataAggregated = userData;
        } else if (userHasScene) {
          // "ä¸ªäººæ•°æ®2-6"æœ‰åœºæ™¯æ•°æ®ï¼šæŒ‰æ¨¡æ¿IDèšåˆ
          const templateAggregated = {};
          userData.forEach(u => {
            if (!templateAggregated[u.id]) {
              templateAggregated[u.id] = {
                id: u.id,
                usePv: 0,
                exportPv: 0
              };
            }
            templateAggregated[u.id].usePv += u.usePv;
            templateAggregated[u.id].exportPv += u.exportPv;
          });
          
          // è®¡ç®—èšåˆåçš„å¯¼å‡ºç‡
          personalDataAggregated = Object.values(templateAggregated).map(t => ({
            ...t,
            exportRate: t.usePv > 0 ? t.exportPv / t.usePv : 0
          }));
        } else {
          // æ²¡æœ‰åœºæ™¯æ•°æ®ï¼šç›´æ¥ä½¿ç”¨
          personalDataAggregated = userData;
        }
        
        const sortedPersonal = [...personalDataAggregated].sort((a, b) => (b.exportRate || 0) - (a.exportRate || 0));
        sortedPersonal.slice(0, 10).forEach(u => personalTop10ByRate.add(String(u.id)));
        console.log(`ä¸ªäººæ•°æ®å¯¼å‡ºç‡å‰åæ¨¡æ¿ID (${currentUserSheet}${shouldSeparateByScene ? ',æŒ‰åœºæ™¯åŒºåˆ†' : ',èšåˆ'}):`, Array.from(personalTop10ByRate));
      }
      
      // è®¡ç®—å…¨ä½“æ•°æ®å¯¼å‡ºç‡å‰åï¼ˆå½“å‰åœºæ™¯ä¸‹æ¨¡æ¿æ•°æ®è¡¨ä¸­å¯¼å‡ºç‡æœ€é«˜çš„10ä¸ªæ¨¡æ¿ï¼‰
      // æ’é™¤ä½¿ç”¨PV < 100çš„æ¨¡æ¿ï¼Œç¡®ä¿æ•°æ®æœ‰æ•ˆæ€§
      const globalTop10ByRate = new Set();
      if (sceneData.length > 0) {
        const filteredGlobal = sceneData.filter(t => t.usePv >= 100);
        console.log(`å…¨ä½“æ•°æ®ï¼ˆå½“å‰åœºæ™¯ï¼‰ï¼šæ€»${sceneData.length}ä¸ªæ¨¡æ¿ï¼Œè¿‡æ»¤åï¼ˆä½¿ç”¨PVâ‰¥100ï¼‰${filteredGlobal.length}ä¸ªæ¨¡æ¿`);
        const sortedGlobal = [...filteredGlobal].sort((a, b) => (b.exportRate || 0) - (a.exportRate || 0));
        sortedGlobal.slice(0, 10).forEach(t => globalTop10ByRate.add(String(t.id)));
        console.log('å…¨ä½“æ•°æ®ï¼ˆå½“å‰åœºæ™¯ï¼‰å¯¼å‡ºç‡å‰åæ¨¡æ¿IDï¼ˆä½¿ç”¨PVâ‰¥100ï¼‰:', Array.from(globalTop10ByRate));
      }
      
      // ä¸ºæ¯æ¡è®°å½•è®¡ç®—åˆ†æ•°
      const results = sceneData.map(t => {
        // A/Bï¼šè¯¥æ¨¡æ¿åœ¨è¯¥åœºæ™¯çš„æ•°æ®
        const A = t.exportPv * coefA;
        const B = Math.max(t.usePv - t.exportPv, 0) * coefB;
        
        // C/Dï¼šè¯¥æ¨¡æ¿çš„ä¸ªäººæ•°æ®
        let user;
        if (userHasScene) {
          // æŒ‰æ¨¡æ¿ID+åœºæ™¯åŒ¹é…
          const userKey = `${t.id}_${t.scene}`;
          user = userMap[userKey] || { usePv: 0, exportPv: 0 };
        } else {
          // åªæŒ‰æ¨¡æ¿IDåŒ¹é…ï¼ˆèšåˆæ•°æ®ï¼‰
          user = userMap[t.id] || { usePv: 0, exportPv: 0 };
        }
        
        const C = user.exportPv * coefC;
        const D = Math.max(user.usePv - user.exportPv, 0) * coefD;
        
        // æ¨¡æ¿IDåˆ†
        const idScore = calcIdScore(t.id);
        
        // è·å–æ¨¡æ¿è¯¦ç»†ä¿¡æ¯
        const info = templateInfo[t.id] || {};
        const templateType = info.type || '';
        const templateRatio = info.ratio || '0';
        const templateSlots = info.slots || 0;
        const templateDuration = info.duration || 0;
        
        // æ£€æŸ¥æ˜¯å¦å¯ç”¨E/F/Gæ–°è§„åˆ™
        const enableNewRules = document.getElementById('enableNewRules').checked;
        
        // Eï¼šæ¨¡æ¿æ¯”ä¾‹åˆ†
        const E = enableNewRules ? calcRatioScore(templateType, templateRatio, userRatio, ratioScores) : 0;
        
        // Fï¼šæ¨¡æ¿ç‰‡æ®µåˆ†
        const F = enableNewRules ? calcSegmentScore(templateType, templateSlots, userSegments, segmentScores) : 0;
        
        // Gï¼šæ¨¡æ¿æ—¶é•¿åˆ†
        const G = enableNewRules ? calcDurationScore(templateType, templateDuration, durationScores) : 0;
        
        // æ€»åˆ† = åŸºç¡€åˆ† + A - B + C - D + IDåˆ† + E + F + G
        const score = baseScore + A - B + C - D + idScore + E + F + G;
        
        return {
          ...t,
          name: info.name || 'æœªå‘½åæ¨¡æ¿',
          type: templateType,
          ratio: templateRatio,
          slots: templateSlots,
          duration: templateDuration,
          A, B, C, D, idScore, E, F, G, score,
          isPersonalTop10: personalTop10ByRate.has(String(t.id)),
          isGlobalTop10: globalTop10ByRate.has(String(t.id))
        };
      });
      
      // æŒ‰åˆ†æ•°é™åºæ’åº
      results.sort((a, b) => b.score - a.score);
      
      // ä¿å­˜å½“å‰ç»“æœç”¨äºå¯¼å‡º
      currentResults = results;
      currentScene = scene;
      
      // æ¸²æŸ“ Top 10
      const top10 = results.slice(0, 10);
      document.getElementById('topCards').innerHTML = top10.map(r => {
        const info = templateInfo[r.id] || {};
        const scenesText = info.scenes && info.scenes.length > 0 
          ? info.scenes.join(', ') 
          : 'æœªè®¾ç½®';
        
        // ç”Ÿæˆæ ‡è¯†å¾½ç« 
        let badges = '';
        if (r.isPersonalTop10) {
          badges += '<span style="background:#10b981;color:#fff;padding:2px 6px;border-radius:4px;font-size:10px;margin-left:6px;">ä¸ªäººTOP10</span>';
        }
        if (r.isGlobalTop10) {
          badges += '<span style="background:#3b82f6;color:#fff;padding:2px 6px;border-radius:4px;font-size:10px;margin-left:6px;">å…¨é‡TOP10</span>';
        }
        
        // åˆ¤æ–­æ¯”ä¾‹åŒ¹é…æƒ…å†µï¼Œè®¾ç½®æ ‡é¢˜é¢œè‰²ï¼ˆä»…å¯¹UGCæ¨¡æ¿ï¼‰
        let titleColor = '#111827'; // é»˜è®¤é»‘è‰²
        const templateRatio = r.ratio;
        const userRatioValue = userRatio; // ç”¨æˆ·è®¾ç½®çš„æ¯”ä¾‹
        
        // åªå¯¹UGCæ¨¡æ¿è¿›è¡Œæ¯”ä¾‹é¢œè‰²æ ‡è®°ï¼Œå¡ç‚¹å’Œå¸¸è§„æ¨¡æ¿ä¸æ ‡è®°
        if (r.type === 'UGC') {
          // å®šä¹‰è¿‘ä¼¼æ¯”ä¾‹å…³ç³»
          const similarRatios = {
            '16:9': ['4:3'],
            '4:3': ['16:9'],
            '9:16': ['3:4'],
            '3:4': ['9:16']
          };
          
          if (templateRatio !== userRatioValue) {
            // æ£€æŸ¥æ˜¯å¦ä¸ºè¿‘ä¼¼æ¯”ä¾‹
            const similars = similarRatios[userRatioValue] || [];
            if (similars.includes(templateRatio)) {
              titleColor = '#f59e0b'; // é»„è‰²/æ©™è‰² - è¿‘ä¼¼
            } else {
              titleColor = '#ef4444'; // çº¢è‰² - ä¸åŒ¹é…
            }
          }
          // å¦‚æœåŒ¹é…ï¼Œä¿æŒé»˜è®¤é»‘è‰²
        }
        
        return `
        <div class="card-item">
          <h4 style="color:${titleColor};">${r.name} <span class="muted">#${r.id}</span>${badges}</h4>
          <div class="meta">å½“å‰åœºæ™¯ï¼š${r.scene}${r.type ? ' | ' + r.type : ''}</div>
          <div class="meta" style="font-size:11px;color:#8b5cf6;">æ”¯æŒåœºæ™¯ï¼š${scenesText}</div>
          <div class="meta" style="font-size:11px;color:#666;">
            æ¯”ä¾‹:${r.ratio} | æ§½ä½:${r.slots} | æ—¶é•¿:${r.duration}s
          </div>
          <div class="meta">å¾—åˆ†ï¼š<strong>${r.score.toFixed(2)}</strong></div>
          <div class="meta" style="font-size:11px;">
            A:${r.A.toFixed(2)} B:${r.B.toFixed(2)} C:${r.C.toFixed(2)} D:${r.D.toFixed(2)} ID:${r.idScore.toFixed(4)}<br>
            E(æ¯”ä¾‹):${r.E >= 0 ? '+' : ''}${r.E.toFixed(0)} F(ç‰‡æ®µ):${r.F >= 0 ? '+' : ''}${r.F.toFixed(0)} G(æ—¶é•¿):${r.G >= 0 ? '+' : ''}${r.G.toFixed(0)}
          </div>
          <div class="meta" style="font-size:11px;color:#999;">
            åœºæ™¯PV: ${r.usePv}ä½¿ç”¨/${r.exportPv}å¯¼å‡º | å¯¼å‡ºç‡: ${(r.exportRate * 100).toFixed(2)}%
          </div>
        </div>
      `;}).join('');
      
      // æ¸²æŸ“å…¨éƒ¨åˆ—è¡¨
      document.getElementById('listContainer').innerHTML = results.map((r, i) => {
        const info = templateInfo[r.id] || {};
        const scenesText = info.scenes && info.scenes.length > 0 
          ? 'æ”¯æŒ:' + info.scenes.join(',') 
          : '';
        
        // åˆ¤æ–­æ¯”ä¾‹åŒ¹é…æƒ…å†µï¼Œè®¾ç½®æ ‡é¢˜é¢œè‰²ï¼ˆä»…å¯¹UGCæ¨¡æ¿ï¼‰
        let titleColor = '#111827'; // é»˜è®¤é»‘è‰²
        const templateRatio = r.ratio;
        const userRatioValue = userRatio;
        
        // åªå¯¹UGCæ¨¡æ¿è¿›è¡Œæ¯”ä¾‹é¢œè‰²æ ‡è®°ï¼Œå¡ç‚¹å’Œå¸¸è§„æ¨¡æ¿ä¸æ ‡è®°
        if (r.type === 'UGC') {
          // å®šä¹‰è¿‘ä¼¼æ¯”ä¾‹å…³ç³»
          const similarRatios = {
            '16:9': ['4:3'],
            '4:3': ['16:9'],
            '9:16': ['3:4'],
            '3:4': ['9:16']
          };
          
          if (templateRatio !== userRatioValue) {
            // æ£€æŸ¥æ˜¯å¦ä¸ºè¿‘ä¼¼æ¯”ä¾‹
            const similars = similarRatios[userRatioValue] || [];
            if (similars.includes(templateRatio)) {
              titleColor = '#f59e0b'; // é»„è‰²/æ©™è‰² - è¿‘ä¼¼
            } else {
              titleColor = '#ef4444'; // çº¢è‰² - ä¸åŒ¹é…
            }
          }
        }
        
        // ç”Ÿæˆæ ‡è¯†å¾½ç« 
        let listBadges = '';
        if (r.isPersonalTop10) {
          listBadges += '<span style="background:#10b981;color:#fff;padding:1px 4px;border-radius:3px;font-size:9px;margin-left:4px;">ä¸ªäººTOP10</span>';
        }
        if (r.isGlobalTop10) {
          listBadges += '<span style="background:#3b82f6;color:#fff;padding:1px 4px;border-radius:3px;font-size:9px;margin-left:4px;">å…¨é‡TOP10</span>';
        }
        
        return `
        <div class="list-item">
          <div class="muted" style="font-weight:600;">#${i + 1}</div>
          <div>
            <div style="color:${titleColor};">
              ${r.name} <span class="muted">#${r.id}</span>
              ${r.type ? `<span class="badge">${r.type}</span>` : ''}
              ${listBadges}
            </div>
            <div class="muted" style="font-size:11px;">
              PV: ${r.usePv}/${r.exportPv} | æ¯”ä¾‹:${r.ratio} æ§½ä½:${r.slots} æ—¶é•¿:${r.duration}s | 
              ${scenesText ? scenesText + ' | ' : ''}
              åˆ†è§£: ${baseScore}+${r.A.toFixed(1)}-${r.B.toFixed(1)}+${r.C.toFixed(1)}-${r.D.toFixed(1)}+${r.idScore.toFixed(2)}+${r.E.toFixed(0)}+${r.F.toFixed(0)}+${r.G.toFixed(0)}
            </div>
          </div>
          <div><strong>${r.score.toFixed(2)}</strong></div>
        </div>
      `;}).join('');
      
      document.getElementById('topSummary').innerText = `åœºæ™¯ï¼š${scene}`;
      document.getElementById('listCount').innerText = `${results.length} æ¡`;
    }

    // åˆ‡æ¢ä¸ªäººæ•°æ®è¡¨
    function switchUserData() {
      const selectedSheet = document.getElementById('userDataSelect').value;
      if (!selectedSheet) return;
      
      console.log(`åˆ‡æ¢ä¸ªäººæ•°æ®è¡¨ï¼š${currentUserSheet} â†’ ${selectedSheet}`);
      loadUserData(selectedSheet);
      
      // é‡æ–°è®¡ç®—ç»“æœ
      compute();
    }

    // é‡ç½®å‚æ•°
    function resetParams() {
      document.getElementById('baseScore').value = 100;
      document.getElementById('coefA').value = 0.5;
      document.getElementById('coefB').value = 0.05;
      document.getElementById('coefC').value = 10;
      document.getElementById('coefD').value = 5;
      compute();
    }

    // å¯¼å‡ºç»“æœ
    function exportResults() {
      if (!currentResults || currentResults.length === 0) {
        alert('æš‚æ— æ•°æ®å¯å¯¼å‡ºï¼Œè¯·å…ˆé€‰æ‹©åœºæ™¯');
        return;
      }

      try {
        // è·å–å½“å‰å‚æ•°
        const baseScore = Number(document.getElementById('baseScore').value) || 100;
        
        // æ„å»ºå¯¼å‡ºæ•°æ®
        const exportData = currentResults.map((r, index) => {
          const info = templateInfo[r.id] || {};
          return {
            'æ’å': index + 1,
            'æ¨¡æ¿ID': r.id,
            'æ¨¡æ¿åç§°': r.name || 'æœªå‘½åæ¨¡æ¿',
            'æ¨¡æ¿ç±»å‹': r.type || '-',
            'æ¨¡æ¿æ¯”ä¾‹': r.ratio || '-',
            'æ¨¡æ¿æ§½ä½æ•°': r.slots || 0,
            'æ¨¡æ¿æ—¶é•¿(s)': r.duration || 0,
            'æ”¯æŒåœºæ™¯': info.scenes ? info.scenes.join(', ') : '-',
            'å½“å‰åœºæ™¯': r.scene,
            'åœºæ™¯ä½¿ç”¨PV': r.usePv,
            'åœºæ™¯å¯¼å‡ºPV': r.exportPv,
            'æ€»åˆ†': Math.round(r.score * 100) / 100,
            'åŸºç¡€åˆ†': baseScore,
            'Aå€¼': Math.round(r.A * 100) / 100,
            'Bå€¼': Math.round(r.B * 100) / 100,
            'Cå€¼': Math.round(r.C * 100) / 100,
            'Då€¼': Math.round(r.D * 100) / 100,
            'IDåˆ†': Math.round(r.idScore * 10000) / 10000,
            'Eå€¼(æ¯”ä¾‹åˆ†)': Math.round(r.E * 100) / 100,
            'Få€¼(ç‰‡æ®µåˆ†)': Math.round(r.F * 100) / 100,
            'Gå€¼(æ—¶é•¿åˆ†)': Math.round(r.G * 100) / 100,
            'è®¡ç®—å…¬å¼': `${baseScore}+${r.A.toFixed(2)}-${r.B.toFixed(2)}+${r.C.toFixed(2)}-${r.D.toFixed(2)}+${r.idScore.toFixed(4)}+${r.E.toFixed(0)}+${r.F.toFixed(0)}+${r.G.toFixed(0)}`
          };
        });

        // åˆ›å»ºå·¥ä½œç°¿
        const ws = XLSX.utils.json_to_sheet(exportData);
        
        // è®¾ç½®åˆ—å®½
        const colWidths = [
          { wch: 6 },  // æ’å
          { wch: 12 }, // æ¨¡æ¿ID
          { wch: 20 }, // æ¨¡æ¿åç§°
          { wch: 10 }, // æ¨¡æ¿ç±»å‹
          { wch: 10 }, // æ¨¡æ¿æ¯”ä¾‹
          { wch: 12 }, // æ¨¡æ¿æ§½ä½æ•°
          { wch: 12 }, // æ¨¡æ¿æ—¶é•¿
          { wch: 30 }, // æ”¯æŒåœºæ™¯
          { wch: 15 }, // å½“å‰åœºæ™¯
          { wch: 12 }, // åœºæ™¯ä½¿ç”¨PV
          { wch: 12 }, // åœºæ™¯å¯¼å‡ºPV
          { wch: 10 }, // æ€»åˆ†
          { wch: 8 },  // åŸºç¡€åˆ†
          { wch: 8 },  // Aå€¼
          { wch: 8 },  // Bå€¼
          { wch: 8 },  // Cå€¼
          { wch: 8 },  // Då€¼
          { wch: 8 },  // IDåˆ†
          { wch: 12 }, // Eå€¼(æ¯”ä¾‹åˆ†)
          { wch: 12 }, // Få€¼(ç‰‡æ®µåˆ†)
          { wch: 12 }, // Gå€¼(æ—¶é•¿åˆ†)
          { wch: 50 }  // è®¡ç®—å…¬å¼
        ];
        ws['!cols'] = colWidths;
        
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, `${currentScene}åœºæ™¯æ’å`);
        
        // ç”Ÿæˆæ–‡ä»¶å
        const date = new Date();
        const dateStr = `${date.getFullYear()}${String(date.getMonth()+1).padStart(2,'0')}${String(date.getDate()).padStart(2,'0')}`;
        const timeStr = `${String(date.getHours()).padStart(2,'0')}${String(date.getMinutes()).padStart(2,'0')}`;
        const fileName = `æ¨¡æ¿æ¨è_${currentScene}åœºæ™¯_${dateStr}_${timeStr}.xlsx`;
        
        // ä¸‹è½½æ–‡ä»¶
        XLSX.writeFile(wb, fileName);
        
        console.log(`å¯¼å‡ºæˆåŠŸï¼š${fileName}ï¼Œå…±${currentResults.length}æ¡è®°å½•`);
      } catch (e) {
        console.error('å¯¼å‡ºå¤±è´¥:', e);
        alert('å¯¼å‡ºå¤±è´¥: ' + e.message);
      }
    }

    // åˆå§‹åŒ–
    window.addEventListener('DOMContentLoaded', () => {
      console.log('é¡µé¢åŠ è½½å®Œæˆ');
      console.log('XLSXåº“çŠ¶æ€:', typeof XLSX !== 'undefined' ? 'å·²åŠ è½½' : 'æœªåŠ è½½');
      if (typeof XLSX === 'undefined') {
        document.getElementById('fileStatus').innerText = 'XLSXåº“åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢';
        document.getElementById('fileStatus').style.color = '#ef4444';
      } else {
        loadData();
      }
    });
  </script>
</body>
</html>
